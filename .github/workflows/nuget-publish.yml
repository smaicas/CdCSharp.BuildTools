name: Publish CdCSharp.BuildTools to NuGet

on:
  push:
    tags: ['v*']
    branches: ['master', 'main']
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  CONFIGURATION: 'Release'
  MAJOR_VERSION: 1
  MINOR_VERSION: 0

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Generate Version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If tagged, use version from tag
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Using tag version: $VERSION"
          else
            # Automatic Version: Major.Minor.RunNumber
            VERSION="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ github.run_number }}"
            echo "Generated automatic version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Display Version
        run: echo "ğŸš€ Building CdCSharp.BuildTools version ${{ steps.version.outputs.version }}"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build CdCSharp.BuildTools
        run: |
          echo "ğŸ”§ Building CdCSharp.BuildTools..."
          dotnet build CdCSharp.BuildTools.csproj \
            -c ${{ env.CONFIGURATION }} \
            -p:Version=${{ steps.version.outputs.version }} \
            -p:AssemblyVersion=${{ steps.version.outputs.version }} \
            -p:FileVersion=${{ steps.version.outputs.version }} \
            -v normal
          
          echo "âœ… Build completed successfully!"

      - name: Run Tests
        run: |
          if [ -d "CdCSharp.BuildTools.Tests" ]; then
            echo "ğŸ§ª Running tests..."
            dotnet test CdCSharp.BuildTools.Tests/CdCSharp.BuildTools.Tests.csproj \
              -c ${{ env.CONFIGURATION }} \
              --no-build \
              --verbosity normal
          else
            echo "âš ï¸ No test project found, skipping tests"
          fi

      - name: Pack NuGet Package
        run: |
          echo "ğŸ“¦ Creating NuGet package..."
          dotnet pack CdCSharp.BuildTools.csproj \
            -c ${{ env.CONFIGURATION }} \
            -o ./artifacts \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -p:Version=${{ steps.version.outputs.version }} \
            -p:AssemblyVersion=${{ steps.version.outputs.version }} \
            -p:FileVersion=${{ steps.version.outputs.version }} \
            --no-build \
            -v normal
          
          echo "âœ… Package created successfully!"

      - name: Verify Package Content
        run: |
          echo "ğŸ“¦ Generated packages:"
          ls -la ./artifacts/
          
          PACKAGE_FILE="./artifacts/CdCSharp.BuildTools.${{ steps.version.outputs.version }}.nupkg"
          
          if [[ -f "$PACKAGE_FILE" ]]; then
            echo "âœ… Package file exists: $PACKAGE_FILE"
            
            # Extract and verify package contents
            mkdir -p temp_extract
            unzip -q "$PACKAGE_FILE" -d temp_extract
            
            echo "ğŸ“‹ Package structure:"
            find temp_extract -type f -name "*.dll" | head -20
            
            echo "ğŸ“„ Package metadata:"
            if [[ -f "temp_extract/CdCSharp.BuildTools.nuspec" ]]; then
              cat temp_extract/CdCSharp.BuildTools.nuspec
            fi
            
            # Verify essential files
            if [[ -f "temp_extract/lib/net10.0/CdCSharp.BuildTools.dll" ]]; then
              echo "âœ… Main assembly found"
            else
              echo "âš ï¸ Main assembly not found in expected location"
              echo "Available lib files:"
              find temp_extract/lib -type f
            fi
            
            # Cleanup
            rm -rf temp_extract
          else
            echo "âŒ Package not found: $PACKAGE_FILE"
            exit 1
          fi

      - name: Publish to NuGet
        run: |
          echo "ğŸš€ Publishing CdCSharp.BuildTools to NuGet.org..."
          
          dotnet nuget push "./artifacts/CdCSharp.BuildTools.${{ steps.version.outputs.version }}.nupkg" \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \
            --no-symbols
          
          echo "âœ… Package published successfully!"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifacts/*.nupkg
          generate_release_notes: true
          body: |
            ## ğŸ“¦ CdCSharp.BuildTools v${{ steps.version.outputs.version }}
            
            ### Installation
            ```bash
            dotnet add package CdCSharp.BuildTools --version ${{ steps.version.outputs.version }}
            ```
            
            ### What's Changed
            See the full changelog below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "ğŸ“‹ Build Summary:"
          echo "  ğŸ“¦ Package: CdCSharp.BuildTools"
          echo "  ğŸ”¢ Version: ${{ steps.version.outputs.version }}"
          echo "  ğŸ”§ Configuration: ${{ env.CONFIGURATION }}"
          echo "  âœ… Build: Success"
          echo "  âœ… Pack: Success"
          echo "  âœ… Publish: Success"
          echo ""
          echo "ğŸ¯ Install command:"
          echo "  dotnet add package CdCSharp.BuildTools --version ${{ steps.version.outputs.version }}"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "  https://github.com/${{ github.repository }}/blob/master/README.md"